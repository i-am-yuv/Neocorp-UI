<p-toast></p-toast>
<div class="layout">
    <app-navbar></app-navbar>

    <div class="content-wrapper">
        <!-- <app-sidebar class="sidebar"></app-sidebar> -->
        <div class="sidebar bg-gray-400">
            <app-sidebar></app-sidebar>
        </div>

        <div class="main-content">

            <div *ngIf="!createNew" >
                <div class="center-container  mt-5">
                    <div class="field col-6">
                        <div class="">
                            <img src="/assets/PoImage.png" alt="Image" class="w-full h-auto">
                        </div>
                        <div class="text-center">
                            <b>Streamline procurement with ease?</b><br>
                            <p>create your first Receipt Note today!</p>
                        </div>
                        <div class="text-center">
                            <button type="button" pButton label="Create Receipt Note" (click)="createRN()"
                                class="mb-3 text-lg p-button-raised bg-blue-500 text-white px-4 py-2.5 rounded-md hover:bg-blue-600 "></button>
                        </div>
                    </div>

                </div>
            </div>

            <div *ngIf="createNew" >
                <div class="raised-container">
                    <div class="flex bg-gray-300 button-container">
                        <button type="button" pButton label="Cancel" (click)="OnCancelRN()"
                            class=" mt-3 mb-3 p-button-raised bg-gray-500 text-white px-4 py-2.5 rounded-md hover:bg-gray-600 "></button>
                        <button type="button" pButton label="Create Receipt Note" (click)="finalRNSubmitPage()" [disabled]="this.rnSubTotal == 0"
                            class="mt-3 mr-3 mb-3 p-button-raised bg-blue-500 text-white px-4 py-2.5 rounded-md hover:bg-blue-600 "></button>
                    </div>
                </div>
                <form (ngSubmit)="onSubmitRN()" [formGroup]="rnForm" class="p-5">
                    <h3 class="text-xl">Create Receipt Note</h3>
                    <hr>
                    <div class="flex gap-2">
                        <div class="field col-4">
                            <label class="mr-3 required">Start Date</label>
                            <p-calendar formControlName="startDate" [showIcon]="true" dateFormat="dd-mm-yy"
                                placeholder="Choose Start Date">
                            </p-calendar>
                            <error-message [controlName]="rnForm.controls['startDate']"></error-message>
                        </div>
                        <div class="field col-4">
                            <label class="mr-3 required">End Date</label>
                            <p-calendar formControlName="endDate" [showIcon]="true" dateFormat="dd-mm-yy"
                                placeholder="Choose End Date">
                            </p-calendar>
                            <error-message [controlName]="rnForm.controls['endDate']"></error-message>
                        </div>
                        <div class="field col-4">
                            <label class="mr-3">Receipt Note Number:</label>
                            <h3 *ngIf="this.rnForm.value.receiptNoteNumber">{{ this.rnForm.value.receiptNoteNumber }}</h3>
                            <h4 *ngIf="!this.rnForm.value.receiptNoteNumber">Yet to be created</h4>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <div class="field col-4">
                            <label class="mr-3 required">Vendor</label>
                            <ng-container formGroupName="vendor">
                                <div class="payment-dropdown ">
                                    <p-dropdown [options]="vendors" placeholder="Choose Vendor" optionValue="id"
                                        formControlName="id" optionLabel="firstName" [showClear]="true"
                                        (ngChange)="selectVendor()">
                                    </p-dropdown>
                                </div>
                            </ng-container>
                        </div>
                        <div class="field col-4">
                            <label class="mr-3 required">Customer</label>
                            <ng-container formGroupName="customer">
                                <div class="payment-dropdown ">
                                    <p-dropdown [options]="vendors" placeholder="Choose Vendor" optionValue="id"
                                        formControlName="id" optionLabel="firstName" [showClear]="true"
                                        (ngChange)="selectVendor()">
                                    </p-dropdown>
                                </div>
                            </ng-container>
                        </div>
                        <div class="field col-4">
                            <label class="mr-3 required">Place Of Supply</label>
                            <ng-container formGroupName="placeOfSupply">
                                <div class="payment-dropdown ">
                                    <p-dropdown [options]="states" placeholder="Choose State" optionValue="id"
                                        formControlName="id" optionLabel="stateName" [showClear]="true"
                                        (ngChange)="selectVendor()">
                                    </p-dropdown>
                                </div>
                            </ng-container>    
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <div class="field col-4">
                            <label class="mr-3">Description</label>
                            <input pInputText formControlName="description" placeholder="Description"
                                class="w-full" />
                            <error-message [controlName]="rnForm.controls['description']"></error-message>
                        </div>
                        <div class="field col-4">
                            <label class="mr-3">Internal Notes</label>
                            <input pInputText formControlName="internalNotes" placeholder="Internsl Notes"
                                class="w-full" />
                            <error-message [controlName]="rnForm.controls['internalNotes']"></error-message>
                        </div>
                        <div class="field col-4">
                            <label class="mr-3">Client Notes</label>
                            <input pInputText formControlName="clientNotes" placeholder="Client Notes"
                                class="w-full" />
                            <error-message [controlName]="rnForm.controls['clientNotes']"></error-message>
                        </div>
                    </div>

                    <div class="flex">
                        <div class="field col-4">
                            <button type="submit" pButton label="Save" [disabled]="!rnForm.valid"
                            class="mb-6 text-lg p-button-raised bg-green-500 text-white px-4 py-2.5 rounded-md hover:bg-green-600 "></button>
                        </div>
                    </div>

                </form>

                <div *ngIf="id">
                    <p-table #dt [value]="lineitems" dataKey="id" editMode="row"
                        styleClass="p-datatable-gridlines mt-2">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Product</th>
                                <th class="text-right" width="100">Price</th>
                                <th class="text-right" width="100">Quantity</th>
                                <th class="text-right" width="100">Discount</th>
                                <th class="text-right" width="100">Total</th>
                                <th width="160" *ngIf="!viewOnly">
                                    <button pButton label="Add Item" icon="pi pi-plus"
                                        class="p-button-secondary p-button-outlined mr-3" (click)="enableRowSubmit()"
                                        (click)="newRecord = !newRecord" pAddRow [table]="dt" [newRow]="newRow()"
                                        [inProgress]="newRecord" [disabled]="newRecord"></button>
                                </th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-lineItem let-editing="editing" let-ri="rowIndex">
                            <tr [pEditableRow]="lineItem">
                                <td>
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <p-dropdown [options]="products" [(ngModel)]="lineItem.expenseName.id"
                                                placeholder="Choose Product" optionValue="id" optionLabel="name"
                                                [showClear]="true" (ngModelChange)="setLineValues(lineItem)">
                                            </p-dropdown>
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{ lineItem?.expenseName?.name }}
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td class="text-right">
                                    <!-- {{ lineItem?.unitprice | number : "1.2-2" }} -->
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <p-inputNumber [(ngModel)]="lineItem.unitPrice"
                                                (onInput)="setLineQtyValuesPrice($event, lineItem)" [format]="false"
                                                [required]="true">
                                            </p-inputNumber>
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{ lineItem?.unitPrice }}
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td class="text-right">
                                    <!-- {{ lineItem?.quantity | number : "1.2-2" }} -->
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <p-inputNumber [(ngModel)]="lineItem.quantity"
                                                (onInput)="setLineQtyValuesQuantity($event, lineItem)" [format]="false"
                                                [required]="true">
                                            </p-inputNumber>
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{ lineItem?.quantity }}
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td class="text-right">
                                    <!-- {{ lineItem?.discount | number : "1.2-2" }} -->
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <p-inputNumber [(ngModel)]="lineItem.discount"
                                                (onInput)="setLineQtyValuesDiscount($event, lineItem)" [format]="false"
                                                [required]="true">
                                            </p-inputNumber>
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{ lineItem?.discount }}
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td class="text-right">
                                    {{ ((lineItem?.unitPrice)*(lineItem?.quantity))-(lineItem?.discount) | number : "1.2-2" }}
                                </td>
                                <td *ngIf="!viewOnly">
                                    <div>
                                        <button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow
                                            icon="pi pi-pencil" (click)="onRowEditInit(lineItem)"
                                            class="p-button-rounded p-button-text"></button>
                                        <button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow
                                            icon="pi pi-trash" (click)="delete(lineItem)"
                                            class="p-button-rounded p-button-text p-button-danger"></button>
                                        <button *ngIf="editing" pButton pRipple type="button" pSaveEditableRow
                                            icon="pi pi-check" (click)="onRowEditSave(lineItem)"
                                            class="p-button-rounded p-button-text p-button-success mr-2"
                                            [disabled]="!isquantity"></button>
                                        <button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow
                                            icon="pi pi-times" (click)="onRowEditCancel(lineItem, ri)"
                                            class="p-button-rounded p-button-text p-button-danger"></button>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="8">
                                    <div class="text-center m-5">
                                        No Receipt Note line Items found create one.
                                    </div>
                                </td>
                            </tr>
                        </ng-template>

                    </p-table>
                    <div class="flex">
                        <div class="col-6">
                            <ul class="list-none p-0 m-0">
                                <li class="flex align-items-center py-3 px-2 border-top-1 surface-border flex-wrap">
                                    <div class="text-500 w-6 md:w-9 font-medium text-right">
                                        Sub Total
                                    </div>
                                    <div class=" w-full font-medium md:w-3 md:flex-order-0 flex-order-1 text-right">
                                        ₹ {{ this.rnSubTotal}}
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="field col-6">
                            <label for="file">Upload File</label>
                            <input type="file" name="file" (change)="selectFile($event)" accept="image/*" class="w-full "
                                chooseLabel="Upload File" />
                        </div>
                    </div>

                    <div class="flex">
                        <div class="field col-12 text-right w-full">
                            <button type="button" pButton label="Create Receipt Note" [disabled]="this.rnSubTotal == 0"
                                (click)="finalRNSubmitPage()"
                                class="mb-6 p-button-raised bg-blue-500 text-white px-4 py-2.5 rounded-md hover:bg-blue-600 "></button>
                        </div>
                    </div>


                </div>

            </div>
        </div>
    </div>
    <p-blockUI [blocked]="submitted">
        <i class="pi pi-spin pi-spinner" style="font-size: 3rem"></i>
    </p-blockUI>
</div>